# MacroDroid 설정 가이드 (입금 알림 -> Melodic 자동 승인)

이 문서는 **문자(SMS)로 오는 입금 알림**을 MacroDroid가 감지해서
`receiveDeposit`로 전송하는 방법을 설명합니다.

---

## 1. 앱 설치/권한
- MacroDroid 설치
- 알림 접근 권한 허용
- 배터리 최적화 해제 (백그라운드 실행 유지)

---

## 2. 매크로 만들기

### 2-1. 트리거 설정
1) **알림 수신됨** 선택  
2) **앱**: `메시지` (은행 SMS가 뜨는 앱)  
3) **텍스트 조건**: `입금` 포함

---

### 2-2. 액션 설정 (HTTP 요청)
1) **HTTP 요청** 선택  
2) 값 입력:

| 항목 | 값 |
|---|---|
| URL | `https://asia-northeast3-melodic-e7c2a.cloudfunctions.net/receiveDeposit` |
| Method | `POST` |
| Content-Type | `application/json` |
| Body | 아래 JSON 참고 |

#### Body 예시 (테스트용 고정값)
```json
{
  "name": "곽철우",
  "amount": 5000
}
```

> 먼저 고정값으로 동작 확인 후, 아래처럼 알림 텍스트에서 자동 추출로 변경하세요.

---

## 3. 알림 텍스트에서 자동 추출 (권장)
은행 SMS 예시:
```
[Web발신] 우리 01/02 00:47
입금 5,000원
곽철우
잔액 54,759원
```

### 3-1. 변수 만들기
- **변수**: `notif` = `{notification_text}`

### 3-2. 금액 추출 (간단 패턴)
- 정규식 추출(Regex) 또는 문자열 분리 기능 사용  
예: `입금 ([0-9,]+)원` 에서 숫자만 추출 → 콤마 제거 → 숫자로 변환

### 3-3. 이름 추출
- 위 예시처럼 **입금 다음 줄이 이름**이면  
  "입금" 라인 다음 줄을 이름으로 사용

### 3-4. 최종 Body 예시 (변수 사용)
```json
{
  "name": "{name_var}",
  "amount": {amount_var}
}
```

---

## 4. 테스트 체크리스트
- MacroDroid에서 매크로 실행 로그가 남는지 확인
- Firestore `reservations` 문서가 `paid`로 변경되는지 확인
- 이메일 발송 여부 확인

---

## 5. 문제 해결

| 증상 | 해결 |
|---|---|
| 매크로가 실행되지 않음 | 알림 접근 권한/배터리 최적화 확인 |
| HTTP 요청 실패 | URL/네트워크 확인 |
| 매칭 실패 | 예약자 이름과 입금자명 동일 여부 확인 |
| 상태가 안 바뀜 | Body에 `name`, `amount` 전달 여부 확인 |

